---
title: "IMDb Top 250 TV Series"
editor_options: 
  chunk_output_type: console
output:
  html_document:
    includes:
      in_header: header/header.html
      after_body: include_footer.html
---

Binge watching can be extremely satisfying if done for the right show. Quite often though, it's done for the wrong show with a pretty shitty ending or a lot of filler episodes that you just get bored of. So maybe if you were to choose the right show to binge watch, that would help with choosing the right show to binge watch (or at least avoid). Nobody wants that Game of Thrones finale feeling.

```{r setup, include=FALSE}
# Set default chunk output
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  results = "asis"
)
```

```{r libraries}
library(tidyverse)
library(DT)
```

```{r data}
all_eps_ratings_tib = read_csv(here::here("data", "top250_imdb_series.csv"))
```

We'll focus our attention to IMDb since they make it so easy to web scrape with their interface. And they already have a list of the top 250 tv series based on overall series rating. That list can be found [here](https://www.imdb.com/chart/toptv/).

Now the time consuming part would be to click every single series, go into their episode guide, go into each season, and look at every single rating of each episode. Luckily we have **rvest**, so we can do that automatically. Check source code on my [GitHub](https://github.com/cavandonohoe/cavandonohoe.github.io) account for details.

[Raw Data](data/top250_imdb_series.csv)
[(Web Scraping Script)](https://github.com/cavandonohoe/cavandonohoe.github.io/blob/main/web_scraping/imdb_tv_series_web_scraping.R)

## Best Episodes Per Series

Some of them are tied and I didn't bother creating any tie breaking metrics or get into all of the detailed ratings per episode. Some may say lazy, but I say efficient on time management. 

```{r best_episode}
max_ratings_per_series = all_eps_ratings_tib %>%
  group_by(imdb_id) %>% 
  filter(rating == max(rating, na.rm = TRUE)) %>% 
  ungroup()

max_ratings_per_series %>% 
  select(series_title, year = release_year, episode_name = title,
         season, episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```


## Did They Close Strong?

I was also wondering whether the last episode was the highest rated one. 

```{r strong_closer}
strong_closer = all_eps_ratings_tib %>%
  group_by(imdb_id) %>%
  filter(row_number() == max(row_number(), na.rm = TRUE) &
           rating == max(rating, na.rm = TRUE)) %>% ungroup()

strong_closer %>% 
  select(series_title, year = release_year, episode_name = title, season,
         episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```

## Did They Start Strong?

Fairly rare, but did a series start with the strongest episode? 

```{r strong_starter}
strong_starter = all_eps_ratings_tib %>%
  group_by(imdb_id) %>% 
  filter(row_number() == min(row_number(), na.rm = TRUE) &
           rating == max(rating, na.rm = TRUE)) %>% ungroup()

strong_starter %>% 
  select(series_title, year = release_year, episode_name = title,
         season, episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```

Looks like people really get wowed over these nature documentaries from the first episode, then they get used to it. 

## Was the Ending Shit?

Looking at you GOT... Ok maybe some of these aren't that bad. Some of these may have just had a strong story leading up and the finale missed it's mark by just a decimal point. But we will never forget Game of Thrones. 

```{r shit_ending}
shit_ending = all_eps_ratings_tib %>%
  group_by(imdb_id) %>% 
  filter(row_number() == max(row_number(), na.rm = TRUE) &
           rating == min(rating, na.rm = TRUE)) %>% ungroup()

shit_ending %>% 
  select(series_title, year = release_year, episode_name = title,
         season, episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```

## Nowhere To Go But Up

Some shows have some god-awful beginnings, and I wonder how they got picked up. But they made this top 250 list, so they must have gotten their shit together.

```{r awful_pilot}
awful_pilot = all_eps_ratings_tib %>%
  group_by(imdb_id) %>% 
  filter(row_number() == min(row_number(), na.rm = TRUE) &
           rating == min(rating, na.rm = TRUE)) %>% ungroup()

awful_pilot %>% 
  select(series_title, year = release_year, episode_name = title,
         season, episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```


## Top Tier Shows

Let's see which shows have a minimum rating of any show as an 8.0

```{r top_tier}
top_tier = all_eps_ratings_tib %>%
  group_by(imdb_id) %>% 
  filter(min(rating) >= 8) %>%
  dplyr::filter(rating == min(rating, na.rm = TRUE)) %>%
  ungroup()

top_tier %>%
  select(series_title, year = release_year, episode_name = title,
         season, episode, rating) %>% 
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```


## Best Streaks

```{r best_streaks}
runs_over_9_formatted <- all_eps_ratings_tib %>%
  dplyr::arrange(series_title, imdb_id, season, episode) %>%
  dplyr::group_by(series_title, imdb_id) %>%
  dplyr::mutate(
    over9 = rating >= 9,
    run_id = cumsum(over9 != dplyr::lag(over9, default = FALSE))
  ) %>%
  dplyr::filter(over9) %>%
  dplyr::group_by(series_title, imdb_id, run_id) %>%
  dplyr::summarise(
    start_season = dplyr::first(season),
    start_episode = dplyr::first(episode),
    end_season = dplyr::last(season),
    end_episode = dplyr::last(episode),
    run_length = dplyr::n(),
    streaks_of_3 = run_length %/% 3,
    run_label = glue::glue(
      "S{start_season}E{start_episode} – ",
      "S{end_season}E{end_episode} ({run_length} episodes)"
    ),
    .groups = "drop"
  ) %>%
  dplyr::filter(streaks_of_3 > 0) %>%
  dplyr::select(series_title, imdb_id, run_length, streaks_of_3, run_label)

runs_over_9_formatted %>%
  dplyr::select(series_title, run_length, run_label) %>%
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```


```{r plotly_runs}
runs_episode_level <- all_eps_ratings_tib %>%
  dplyr::arrange(series_title, imdb_id, season, episode) %>%
  dplyr::group_by(series_title, imdb_id) %>%
  dplyr::mutate(
    over9 = rating >= 9,
    run_id = cumsum(over9 != dplyr::lag(over9, default = FALSE))
  ) %>%
  dplyr::filter(over9) %>%
  dplyr::ungroup()

runs_over_9_full <- runs_episode_level %>%
  dplyr::group_by(series_title, imdb_id, run_id) %>%
  dplyr::summarise(
    start_season  = dplyr::first(season),
    start_episode = dplyr::first(episode),
    end_season    = dplyr::last(season),
    end_episode   = dplyr::last(episode),
    run_length    = dplyr::n(),
    run_label = glue::glue(
      "S{start_season}E{start_episode} – ",
      "S{end_season}E{end_episode} ({run_length} episodes)"
    ),
    .groups = "drop"
  )

max_runs <- runs_over_9_full %>%
  dplyr::group_by(series_title, imdb_id) %>%
  dplyr::slice_max(run_length, n = 1, with_ties = FALSE) %>%
  dplyr::ungroup()

max_runs_top20 <- max_runs %>%
  dplyr::arrange(dplyr::desc(run_length)) %>%
  dplyr::slice_head(n = 20)


episodes_for_hover <- runs_episode_level %>%
  dplyr::select(
    series_title,
    imdb_id,
    run_id,
    season,
    episode,
    title,
    rating
  )

max_runs_hover <- max_runs_top20 %>%
  dplyr::inner_join(
    episodes_for_hover,
    by = c("series_title", "imdb_id", "run_id")
  ) %>%
  dplyr::arrange(series_title, season, episode)

max_runs_hover_summarised <- max_runs_hover %>%
  dplyr::group_by(series_title, imdb_id, run_id, run_length, run_label) %>%
  dplyr::reframe(
    hover_text = paste0(
      run_label, "\n",
      paste0(
        "• S", season, "E", episode, " – ", title,
        " (", rating, ")",
        collapse = "\n"
      )
    )
  ) %>%
  dplyr::distinct()


plot_data <- max_runs_top20 %>%
  dplyr::left_join(
    max_runs_hover_summarised,
    by = c("series_title", "imdb_id", "run_id", "run_length", "run_label")
  )


p <- max_runs_hover_summarised %>%
  dplyr::arrange(run_length) %>%
  ggplot2::ggplot(
    ggplot2::aes(
      x = run_length,
      y = stats::reorder(series_title, run_length),
      text = hover_text    # used ONLY for plotly tooltip
    )
  ) +
  ggplot2::geom_col() +
  
  # --- your numeric label stays here ---
  ggplot2::geom_text(
    ggplot2::aes(
      label = run_length,
      x = run_length + 1   # push text slightly outside the bar
    ),
    hjust = 0,
    size = 3.5
  ) +
  # -------------------------------------

ggplot2::labs(
  title = "Top 20 longest streaks of IMDb ratings ≥ 9",
  x = "Streak length (episodes)",
  y = "Series"
) +
  ggplot2::scale_x_continuous(
    expand = ggplot2::expansion(mult = c(0, 0.15))  # ensure text isn't cut off
  )


plotly::ggplotly(p, tooltip = "text")
```

## Streaks of 3 ≥ 9.0 IMDb Episodes in a Row

```{r streaks_of_3}
runs_over_9_streaks <- all_eps_ratings_tib %>%
  dplyr::arrange(series_title, imdb_id, season, episode) %>%
  dplyr::group_by(series_title, imdb_id) %>%
  dplyr::mutate(
    over9 = rating >= 9,
    run_id = cumsum(over9 != dplyr::lag(over9, default = FALSE))
  ) %>%
  dplyr::filter(over9) %>%
  dplyr::group_by(series_title, imdb_id, run_id) %>%
  dplyr::mutate(
    run_length = dplyr::n()
  ) %>%
  dplyr::filter(run_length >= 3) %>% # drop runs of 1 or 2 completely
  dplyr::mutate(
    run_pos = dplyr::row_number(),
    base_streak_id = (run_pos - 1) %/% 3 + 1,
    n_full = run_length %/% 3,
    remainder = run_length %% 3,
    streak_id = dplyr::if_else(
      base_streak_id > n_full & remainder > 0,
      n_full,
      base_streak_id
    )
  ) %>%
  dplyr::group_by(series_title, imdb_id, run_id, streak_id) %>%
  dplyr::summarise(
    streak_len = dplyr::n(),
    start_season = dplyr::first(season),
    start_episode = dplyr::first(episode),
    end_season = dplyr::last(season),
    end_episode = dplyr::last(episode),
    streak_label = glue::glue(
      "S{start_season}E{start_episode}-S{end_season}E{end_episode} ({streak_len})"
    ),
    .groups = "drop"
  )

streaks_over_9_concat <- runs_over_9_streaks %>%
  dplyr::group_by(series_title, imdb_id) %>%
  dplyr::summarise(
    streaks = paste(streak_label, collapse = "; "),
    n_streaks = dplyr::n(),
    .groups = "drop"
  )

streaks_over_9_concat %>%
  dplyr::select(series_title, streaks, n_streaks) %>%
  datatable(filter = "top", extensions = "Buttons",
            options = list(paging = FALSE, dom = "Bfrtip", buttons = c("copy", "csv", "excel"),
                           scrollY = "400px", scrollX = TRUE))
```

```{r fig.height=14}
p <- ggplot2::ggplot(
  streaks_over_9_concat,
  ggplot2::aes(
    x = reorder(series_title, n_streaks),
    y = n_streaks,
    text = paste(
      "Series:", series_title,
      "\nNumber of streaks:", n_streaks,
      "\nStreaks:\n",
      stringr::str_replace_all(streaks, ";\\s*", "\n")
    )
  )
) +
  ggplot2::geom_col(fill = "steelblue") +
  ggplot2::coord_flip() +
  ggplot2::labs(
    title = "IMDb ≥9 Episode Streaks (Grouped by 3, Remainder Absorbed)",
    x = NULL,
    y = "Number of streaks"
  ) +
  ggplot2::theme_minimal(base_size = 13)

plotly::ggplotly(p, tooltip = "text")


```

